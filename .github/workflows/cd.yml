name: CD Pipeline â€” BookShelf Cloud

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Repositorio: jenpronet/bookshelf-cloud-devops
#
# CuÃ¡ndo se ejecuta:
#   - Push a main       â†’ deploy automÃ¡tico a DEV
#   - Tag v*.*.*        â†’ deploy a PROD (con aprobaciÃ³n manual)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  push:
    branches:
      - main
    tags:
      - "v*.*.*"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# SECRETS requeridos en GitHub â†’ Settings â†’ Secrets:
#   GCP_PROJECT_ID  â†’ ID de tu proyecto GCP
#   GCP_REGION      â†’ ej: us-central1
#   GCP_SA_KEY      â†’ JSON key de la Service Account
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

env:
  GCP_REGION:     ${{ secrets.GCP_REGION }}
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  IMAGE_NAME:     bookshelf-api
  REGISTRY:       ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/bookshelf

jobs:

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# JOB 1: Build y push de imagen a Artifact Registry
# Corre en push a main Y en tags
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-and-push:
    name: ðŸ³ Build & Push imagen
    runs-on: ubuntu-latest

    outputs:
      image_tag: ${{ steps.set_tag.outputs.image_tag }}

    steps:
      - name: ðŸ“¥ Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ·ï¸ Definir tag de la imagen
        id: set_tag
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # En release: usar el tag SemVer (ej: v1.2.0)
            IMAGE_TAG="${{ github.ref_name }}"
          else
            # En main: usar el SHA corto del commit
            IMAGE_TAG="${{ github.sha }}"
          fi
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Tag de imagen: ${IMAGE_TAG}"

      - name: ðŸ”‘ Autenticar en GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # NOTA: Para evitar JSON keys estÃ¡ticas,
          # usar Workload Identity Federation (OIDC):
          # workload_identity_provider: 'projects/PROJECT_NUMBER/...'
          # service_account: 'bookshelf-github-dev@PROJECT_ID.iam.gserviceaccount.com'
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: â˜ï¸ Configurar gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: ðŸ”§ Configurar Docker para Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: ðŸ—ï¸ Build de imagen Docker
        run: |
          docker build \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.set_tag.outputs.image_tag }} \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            .

      - name: ðŸ“¦ Push imagen a Artifact Registry
        run: |
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.set_tag.outputs.image_tag }}
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          echo "âœ… Imagen publicada: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.set_tag.outputs.image_tag }}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# JOB 2: Deploy automÃ¡tico a DEV
# Solo corre en push a main (no en tags)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-dev:
    name: ðŸš€ Deploy â†’ DEV
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main'

    environment:
      name: dev
      url: ${{ steps.get_url.outputs.service_url }}

    steps:
      - name: ðŸ”‘ Autenticar en GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: â˜ï¸ Configurar gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: ðŸš€ Deploy a Cloud Run DEV
        run: |
          gcloud run deploy bookshelf-dev \
            --image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.image_tag }} \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --min-instances=0 \
            --max-instances=2 \
            --memory=512Mi \
            --cpu=1 \
            --set-env-vars="ENVIRONMENT=dev" \
            --set-secrets="DATABASE_URL=bookshelf-db-url-dev:latest,SECRET_KEY=bookshelf-secret-key-dev:latest" \
            --quiet

      - name: ðŸ”— Obtener URL del servicio DEV
        id: get_url
        run: |
          URL=$(gcloud run services describe bookshelf-dev \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')
          echo "service_url=${URL}" >> $GITHUB_OUTPUT
          echo "ðŸŒ DEV URL: ${URL}"

      - name: ðŸ©º Smoke test DEV
        run: |
          URL=$(gcloud run services describe bookshelf-dev \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')

          echo "Esperando que el servicio estÃ© listo..."
          sleep 10

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${URL}/health" || \
                      curl -s -o /dev/null -w "%{http_code}" "${URL}/")

          echo "ðŸ“Š HTTP response: ${HTTP_CODE}"

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 500 ]; then
            echo "âœ… Smoke test DEV: OK (HTTP ${HTTP_CODE})"
          else
            echo "âŒ Smoke test DEV: FALLÃ“ (HTTP ${HTTP_CODE})"
            exit 1
          fi

      - name: ðŸ“ Resumen del deploy DEV
        run: |
          echo "## ðŸš€ Deploy DEV completado" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Campo | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Ambiente | DEV |" >> $GITHUB_STEP_SUMMARY
          echo "| Imagen | \`${{ needs.build-and-push.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Ejecutado por | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# JOB 3: Deploy a PROD (solo en tags, con aprobaciÃ³n manual)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-prod:
    name: ðŸš€ Deploy â†’ PROD
    runs-on: ubuntu-latest
    needs: build-and-push
    if: startsWith(github.ref, 'refs/tags/v')

    # â”€â”€ AprobaciÃ³n manual â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Configurar en: GitHub â†’ Settings â†’ Environments â†’ prod
    # Agregar "Required reviewers" con tu usuario
    environment:
      name: prod
      url: ${{ steps.get_url.outputs.service_url }}

    steps:
      - name: ðŸ”‘ Autenticar en GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: â˜ï¸ Configurar gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: ðŸš€ Deploy a Cloud Run PROD
        run: |
          gcloud run deploy bookshelf-prod \
            --image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.image_tag }} \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --no-allow-unauthenticated \
            --min-instances=1 \
            --max-instances=10 \
            --memory=1Gi \
            --cpu=2 \
            --set-env-vars="ENVIRONMENT=prod" \
            --set-secrets="DATABASE_URL=bookshelf-db-url-prod:latest,SECRET_KEY=bookshelf-secret-key-prod:latest" \
            --quiet

      - name: ðŸ”— Obtener URL del servicio PROD
        id: get_url
        run: |
          URL=$(gcloud run services describe bookshelf-prod \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')
          echo "service_url=${URL}" >> $GITHUB_OUTPUT
          echo "ðŸŒ PROD URL: ${URL}"

      - name: ðŸ©º Smoke test PROD
        run: |
          URL=$(gcloud run services describe bookshelf-prod \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')

          sleep 10

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${URL}/health" || \
                      curl -s -o /dev/null -w "%{http_code}" "${URL}/")

          echo "ðŸ“Š HTTP response: ${HTTP_CODE}"

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 500 ]; then
            echo "âœ… Smoke test PROD: OK (HTTP ${HTTP_CODE})"
          else
            echo "âŒ Smoke test PROD: FALLÃ“ (HTTP ${HTTP_CODE})"
            exit 1
          fi

      - name: ðŸ“ Resumen del deploy PROD
        run: |
          echo "## ðŸš€ Deploy PROD completado" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Campo | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Ambiente | **PROD** âš ï¸ |" >> $GITHUB_STEP_SUMMARY
          echo "| Release | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Imagen | \`${{ needs.build-and-push.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Aprobado por | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
